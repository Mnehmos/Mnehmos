---
interface Props {
  endpoint?: string;
  standalone?: boolean;
}

const { 
  endpoint = "https://mnehmos-rag-production.up.railway.app/chat",
  standalone = false 
} = Astro.props;
---

<div id="chat-widget" class={`flex flex-col ${standalone ? 'h-[calc(100vh-12rem)]' : 'h-125'} bg-white rounded-xl border border-stone-200 overflow-hidden`}>
  <!-- Header -->
  <div class="px-4 py-3 border-b border-stone-200 bg-stone-50">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 bg-copper rounded-lg flex items-center justify-center">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
        </svg>
      </div>
      <div>
        <h3 class="font-semibold text-stone-900">Ask About My Work</h3>
        <p class="text-xs text-stone-500">Powered by RAG over my portfolio</p>
      </div>
    </div>
  </div>

  <!-- Messages Container -->
  <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4">
    <!-- Welcome Message -->
    <div class="flex gap-3">
      <div class="w-8 h-8 bg-copper rounded-lg shrink-0 flex items-center justify-center">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
        </svg>
      </div>
      <div class="bg-stone-100 rounded-lg px-4 py-3 max-w-[85%]">
        <p class="text-stone-700">
          Hi! I'm an AI assistant with knowledge of Mnehmos's projects. Ask me about:
        </p>
        <ul class="mt-2 text-stone-600 text-sm space-y-1">
          <li>• <strong>MCP Servers</strong> - OODA, Index Foundry, Synch, Trace</li>
          <li>• <strong>Multi-Agent Framework</strong> - TDD workflows, roles</li>
          <li>• <strong>Games</strong> - D&D 5e engine, Quest Keeper</li>
          <li>• <strong>Technical details</strong> - Architecture, design patterns</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Input Form -->
  <form id="chat-form" class="p-4 border-t border-stone-200 bg-stone-50">
    <div class="flex gap-2">
      <input
        type="text"
        id="chat-input"
        placeholder="Ask about my projects..."
        class="flex-1 px-4 py-2 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-copper focus:border-transparent"
        autocomplete="off"
      />
      <button
        type="submit"
        id="send-btn"
        class="px-4 py-2 bg-copper text-white rounded-lg font-medium hover:bg-copper-light transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
        </svg>
      </button>
    </div>
    <div class="flex gap-2 mt-2">
      <button type="button" class="quick-prompt px-3 py-1 text-xs bg-stone-200 text-stone-700 rounded-full hover:bg-stone-300 transition-colors">
        What MCP servers exist?
      </button>
      <button type="button" class="quick-prompt px-3 py-1 text-xs bg-stone-200 text-stone-700 rounded-full hover:bg-stone-300 transition-colors">
        How does the D&D engine work?
      </button>
    </div>
  </form>
</div>

<!-- Source Modal -->
<div id="source-modal" class="source-modal-overlay">
  <div class="source-modal">
    <div class="source-modal-header">
      <h3 id="source-title">Source</h3>
      <button class="source-modal-close" id="close-modal">&times;</button>
    </div>
    <div class="source-modal-meta">
      <span class="source-score" id="source-score"></span>
      <span id="source-file"></span>
    </div>
    <div class="source-modal-content">
      <p id="source-text"></p>
    </div>
  </div>
</div>

<script define:vars={{ endpoint }}>
  const messagesEl = document.getElementById('messages');
  const formEl = document.getElementById('chat-form');
  const inputEl = document.getElementById('chat-input');
  const sendBtn = document.getElementById('send-btn');
  const sourceModal = document.getElementById('source-modal');
  const closeModalBtn = document.getElementById('close-modal');
  
  let sources = [];
  
  // Quick prompts
  document.querySelectorAll('.quick-prompt').forEach(btn => {
    btn.addEventListener('click', () => {
      inputEl.value = btn.textContent;
      formEl.dispatchEvent(new Event('submit'));
    });
  });
  
  // Close modal
  closeModalBtn?.addEventListener('click', () => {
    sourceModal?.classList.remove('visible');
  });
  sourceModal?.addEventListener('click', (e) => {
    if (e.target === sourceModal) {
      sourceModal.classList.remove('visible');
    }
  });
  
  // Show source modal
  window.showSource = (idx) => {
    const source = sources[idx];
    if (!source) return;
    
    document.getElementById('source-title').textContent = `Source ${idx + 1}`;
    document.getElementById('source-score').textContent = `Score: ${(source.score * 100).toFixed(1)}%`;
    document.getElementById('source-file').textContent = source.source || source.id || 'Unknown';
    document.getElementById('source-text').textContent = source.text;
    sourceModal?.classList.add('visible');
  };
  
  // Add message to chat
  function addMessage(content, isUser = false, isStreaming = false) {
    const msgDiv = document.createElement('div');
    msgDiv.className = 'flex gap-3' + (isUser ? ' justify-end' : '');
    
    if (isUser) {
      msgDiv.innerHTML = `
        <div class="bg-copper text-white rounded-lg px-4 py-3 max-w-[85%]">
          <p>${escapeHtml(content)}</p>
        </div>
      `;
    } else {
      msgDiv.innerHTML = `
        <div class="w-8 h-8 bg-copper rounded-lg flex-shrink-0 flex items-center justify-center">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
          </svg>
        </div>
        <div class="bg-stone-100 rounded-lg px-4 py-3 max-w-[85%]">
          <p class="text-stone-700 ${isStreaming ? 'streaming-content' : ''}">${isStreaming ? '<span class="generating-placeholder">Thinking...</span>' : content}</p>
        </div>
      `;
    }
    
    messagesEl.appendChild(msgDiv);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    return msgDiv;
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Parse markdown-style formatting
  function parseMarkdown(text) {
    return text
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      .replace(/`(.*?)`/g, '<code class="bg-stone-200 px-1 rounded">$1</code>')
      .replace(/\n/g, '<br>');
  }
  
  // Inject source buttons
  function injectSourceButtons(text) {
    return text.replace(/\[(\d+)\]/g, (match, num) => {
      const idx = parseInt(num) - 1;
      return `<button class="source-btn" onclick="showSource(${idx})">${num}</button>`;
    });
  }
  
  // Handle form submission
  formEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const query = inputEl.value.trim();
    if (!query) return;
    
    inputEl.value = '';
    sendBtn.disabled = true;
    
    // Add user message
    addMessage(query, true);
    
    // Add placeholder for AI response
    const aiMsg = addMessage('', false, true);
    const contentEl = aiMsg.querySelector('.streaming-content');
    
    sources = [];
    let fullResponse = '';
    
    try {
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
      });
      
      if (!response.ok) throw new Error('Network response was not ok');
      
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        
        const chunk = decoder.decode(value);
        const lines = chunk.split('\n');
        
        for (const line of lines) {
          if (!line.startsWith('data: ')) continue;
          
          try {
            const data = JSON.parse(line.slice(6));
            
            if (data.type === 'sources') {
              sources = data.sources || [];
            } else if (data.type === 'delta') {
              fullResponse += data.content;
              contentEl.innerHTML = injectSourceButtons(parseMarkdown(fullResponse));
              messagesEl.scrollTop = messagesEl.scrollHeight;
            } else if (data.type === 'done') {
              // Streaming complete
            }
          } catch (parseErr) {
            // Skip invalid JSON
          }
        }
      }
    } catch (err) {
      contentEl.innerHTML = `<span class="text-red-600">Sorry, I couldn't connect to the chat server. Please try again later.</span>`;
    } finally {
      sendBtn.disabled = false;
    }
  });
</script>
