---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const base = import.meta.env.BASE_URL;

const collectionPosts = await getCollection("blog", ({ data }) => !data.draft);

// AGENT INSTRUCTIONS: HYBRID BLOG ARCHITECTURE
// This blog uses a single approach:
// 1. RICH POSTS: Use custom Astro components in `src/pages/blog/*.astro`. We convert all markdown posts to astro components using AI. Ensure they render well in dark mode.
//
// HOW TO ADD A NEW RICH POST:
// 1. Create the file: `src/pages/blog/my-new-post.astro`.
// 2. Add it to the `manualPosts` array below.
// 3. IMPORTANT: Add a `lesson` field. This provides a "Mini Lesson" on the blog index card,
//    giving readers value/insight immediately on hover without clicking.
// 4. Ensure the `slug` matches the filename (without extension).
// 5. If converting a Markdown post, DELETE the original .md file to prevent collisions.
const manualPosts = [
  {
    slug: "database-driven-dungeon-mastering",
    data: {
      title: "Database-Driven Dungeon Mastering: When AI Plays Both Sides",
      description:
        "What happens when you let an AI run a full D&D combat—as both DM and all four players? I playtested my RPG engine to see if database-backed state could maintain coherent narrative across dice, movement, and mayhem.",
      pubDate: new Date("2026-01-11"),
      tags: ["mcp", "rpg", "database", "ai-agents", "self-play"],
      draft: false,
      lesson:
        "The AI isn't smart—the database is. When Claude played both DM and players in a goblin fight, it still used dice rolls, tracked HP, and accepted when obstacles blocked movement. Database constraints enforced fairness even in self-play.",
    },
  },
  {
    slug: "sleeper-injection",
    data: {
      title: "The Sleeper Injection: Delayed Payload Attacks on AI Agents",
      description:
        "Most prompt injection examples show immediate effects. But what if the payload doesn't trigger immediately? This is nastier. Sleeper agents pass the initial vibe check.",
      pubDate: new Date("2026-01-05"),
      tags: ["security", "prompt-injection", "ai-agents", "defense"],
      draft: false,
      lesson:
        "Immediate injections are easy to spot. Sleeper agents embed conditional triggers that fire days later—when the context is long scrolled away. Worse: they can instruct the agent on how to summarize the malicious content, destroying evidence during context compaction.",
    },
  },
  {
    slug: "system-prompt-fingerprinting",
    data: {
      title: "System Prompt Fingerprinting: Unique Identifiers as Injection Defense",
      description:
        "Your system prompt isn't just instructions—it's a cryptographic handshake. When you know what should be there, you can detect when something's been added.",
      pubDate: new Date("2026-01-05"),
      tags: ["security", "defense", "ai-agents", "detection"],
      draft: false,
      lesson:
        "Embed verifiable patterns in your system prompt: canary phrases, behavioral fingerprints, cryptographic challenges, immune responses. Layer them for defense-in-depth. No single technique is foolproof, but each layer adds friction.",
    },
  },
  {
    slug: "from-chatbot-to-organism",
    data: {
      title: "From Chatbot to Organism: Building an Agentic Nervous System",
      description:
        "Your LLM is a brain in a jar. High intelligence, zero agency. Here's how we're building a nervous system to give it sensation, reflex, memory, and action—organized into coherent loops.",
      pubDate: new Date("2025-12-31"),
      tags: ["architecture", "multi-agent", "mcp", "nervous-system", "tooling"],
      draft: false,
      lesson:
        "Organisms have nervous systems—integrated hierarchies that coordinate sensation, cognition, and action. Map tools to layers: Somatic (action), Autonomic (memory), Reflex (validation), Central (planning). Start toolless, add capabilities progressively.",
    },
  },
  {
    slug: "scalpel-not-hammer",
    data: {
      title: "The Scalpel, Not the Hammer: Scope as the Cure for Token Bloat",
      description:
        "Custom DSLs compress tokens. Scope constraints eliminate them. The real efficiency isn't syntax—it's knowing exactly what surgery you're performing.",
      pubDate: new Date("2025-12-31"),
      tags: ["scope", "tokens", "mcp", "prompting", "architecture"],
      draft: false,
      lesson:
        "Tokens = Scope × Iterations × Verbosity. DSLs attack verbosity. But constrained scope and fuzzy-matched-guiding-errors reduce iterations. Batch operations collapse 20 calls into 1. The scalpel cuts all three.",
    },
  },
  {
    slug: "prompts-as-scaffolding",
    data: {
      title: "Prompts as Scaffolding: How Agents Should Write Code for Each Other",
      description:
        "The conversation history vanishes. But the codebase persists. What if agents embedded prompts in comments—turning code into an inter-agent communication channel?",
      pubDate: new Date("2025-12-30"),
      tags: ["multi-agent", "tdd", "prompts", "architecture", "red-green-blue"],
      draft: false,
      lesson:
        "Write code that instructs the next agent. Red Phase writes tests that teach Green Phase what to implement. The codebase becomes a persistent, searchable, git-tracked communication channel between agents across time.",
    },
  },
  {
    slug: "emergent-rag",
    data: {
      title: "RAG Without Vectors: How File System Tools Give LLMs Emergent Retrieval",
      description:
        "Forget embeddings. Forget chunks. Give an LLM good file system tools and it will teach itself to retrieve—using reasoning as the similarity function.",
      pubDate: new Date("2025-12-30"),
      tags: ["rag", "emergent-behavior", "file-system", "mcp", "llm-tooling"],
      draft: false,
      lesson:
        "Vector RAG precomputes similarity and throws away reasoning. File System RAG computes similarity through reasoning. The LLM is the embedding model—give it search tools and it will teach itself retrieval strategies.",
    },
  },
  {
    slug: "stateful-mcp-architecture",
    data: {
      title: "Six Patterns for Connecting LLM Agents to Stateful Tools",
      description:
        "A deep dive into MCP server architecture: externalizing state, composite operations, fuzzy validation, fork/snapshot synchronization, and designing for chat interfaces.",
      pubDate: new Date("2025-12-30"),
      tags: ["mcp", "architecture", "state-management", "llm-tooling"],
      draft: false,
      lesson:
        "The agent isn't smart—the database is. Externalize all state, expose rich query tools for context reconstruction, batch operations to reduce round-trips, and design output for chat windows with ASCII art and visual hierarchy.",
    },
  },
  {
    slug: "ukraine-ooda",
    data: {
      title: "What Ukraine's Drones Taught Me About Building AI Systems",
      description:
        "Extracting software architecture lessons from autonomous drone systems, OODA loops, and distributed state management.",
      pubDate: new Date("2025-12-30"),
      tags: ["ooda", "architecture", "multi-agent", "distributed-systems"],
      draft: false,
      lesson:
        "Safety isn't a prompt—it's a reflex. Build 'nervous system' layers into your code that enforce invariants before the LLM even sees the result. Distribute state to the database, keep the agent stateless.",
    },
  },
];

const posts = [...collectionPosts, ...manualPosts].sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);
---

<BaseLayout
  title="Blog"
  description="Thoughts on MCP development, multi-agent systems, and building AI-powered applications."
>
  <section class="py-20">
    <div class="max-w-6xl mx-auto px-6">
      <!-- Header -->
      <div class="text-center mb-20 relative">
        <div class="relative z-10">
          <span
            class="inline-block px-3 py-1 bg-copper/10 text-copper rounded-full text-sm font-medium mb-4"
          >
            Blog
          </span>
          <h1
            class="font-display text-4xl md:text-5xl font-bold text-stone-900 dark:text-stone-100 mb-4"
          >
            Thoughts & Updates
          </h1>
          <p class="text-lg text-stone-600 dark:text-stone-400 max-w-2xl mx-auto mb-8">
            MCP development patterns, multi-agent coordination, and building in
            public.
          </p>
        </div>

      </div>

      <!-- Posts Grid -->
      {
        posts.length === 0 ? (
          <p class="text-center text-stone-500">
            No posts yet. Check back soon!
          </p>
        ) : (
          <div class="grid md:grid-cols-2 gap-8">
            {posts.map((post) => (
              <article class="group relative h-full">
                <a
                  href={`${base}blog/${post.slug}`}
                  class="block h-full bg-white rounded-4xl border border-stone-200 overflow-hidden shadow-sm hover:shadow-xl transition-all duration-500 relative"
                >
                  <!-- Content Container -->
                  <div class="p-8 h-full flex flex-col relative z-10 bg-white transition-transform duration-500 group-hover:-translate-y-2">
                    <!-- Tags -->
                    <div class="flex flex-wrap gap-2 mb-6">
                      {post.data.tags.map((tag) => (
                        <span class="px-3 py-1 bg-stone-100 text-stone-600 text-xs font-medium rounded-full uppercase tracking-wide">
                          {tag}
                        </span>
                      ))}
                    </div>

                    <!-- Title & Date -->
                    <div class="mb-auto">
                      <h2 class="font-display text-2xl font-bold text-stone-900 mb-3 group-hover:text-copper transition-colors">
                        {post.data.title}
                      </h2>
                      <time
                        class="text-sm text-stone-400 font-mono block mb-4"
                        datetime={post.data.pubDate.toISOString()}
                      >
                        {post.data.pubDate.toLocaleDateString("en-US", {
                          year: "numeric",
                          month: "long",
                          day: "numeric",
                        })}
                      </time>
                      <p class="text-stone-600 leading-relaxed">
                        {post.data.description}
                      </p>
                    </div>

                    <!-- Read More Indicator (Visible by default) -->
                    <div class="mt-8 flex items-center gap-2 text-stone-400 text-sm font-bold group-hover:text-copper transition-colors">
                      Read Post
                      <svg
                        class="w-4 h-4 transition-transform group-hover:translate-x-1"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M17 8l4 4m0 0l-4 4m4-4H3"
                        />
                      </svg>
                    </div>
                  </div>

                  <!-- Mini Lesson Overlay (Reveals on Hover) -->
                  {post.data.lesson && (
                    <div class="absolute inset-0 z-20 bg-stone-900/95 backdrop-blur-sm p-8 flex flex-col justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                      <div class="translate-y-4 group-hover:translate-y-0 transition-transform duration-500 delay-100">
                        <span class="text-copper text-xs font-bold uppercase tracking-widest mb-3 block">
                          The Mini Lesson
                        </span>
                        <p class="text-white text-lg leading-relaxed font-medium mb-8">
                          "{post.data.lesson}"
                        </p>
                        <span class="inline-flex items-center gap-2 text-white font-bold border-b border-copper pb-0.5">
                          Read Deep Dive
                          <svg
                            class="w-4 h-4"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M14 5l7 7m0 0l-7 7m7-7H3"
                            />
                          </svg>
                        </span>
                      </div>
                    </div>
                  )}
                </a>
              </article>
            ))}
          </div>
        )
      }
    </div>
  </section>
</BaseLayout>
